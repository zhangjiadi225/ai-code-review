<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Webhook 测试</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .card {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn {
      background-color: #2196F3;
      border: none;
      color: white;
      padding: 10px 15px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    .url-box {
      background: #fff;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      word-break: break-all;
    }
    pre {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    #response {
      min-height: 100px;
    }
  </style>
</head>
<body>
  <h1>GitHub Webhook 测试工具</h1>
  
  <div class="card">
    <h2>Webhook URL</h2>
    <div id="webhook-url" class="url-box">正在加载...</div>
    
    <h2>测试请求</h2>
    <button id="test-get" class="btn">发送GET请求</button>
    <button id="test-ping" class="btn">模拟Ping事件</button>
    <button id="test-push" class="btn">模拟Push事件</button>
    
    <h2>响应结果</h2>
    <pre id="response">等待测试...</pre>
  </div>
  
  <div class="card">
    <h2>GitHub Webhook 配置指南</h2>
    <ol>
      <li>进入GitHub仓库设置 -> Webhooks -> Add webhook</li>
      <li>在Payload URL中填入上方显示的Webhook URL</li>
      <li>Content type选择 <code>application/json</code></li>
      <li>Secret可以留空（或者设置一个密钥并在服务器配置中添加）</li>
      <li>选择 "Just the push event" 或根据需要选择其他事件</li>
      <li>确保 "Active" 选项被勾选</li>
      <li>点击 "Add webhook" 按钮</li>
    </ol>
    
    <h3>常见问题</h3>
    <ul>
      <li>如果收到404错误，请确保URL正确且服务器正在运行</li>
      <li>如果收到超时错误，可能是内网穿透服务不稳定，尝试重启服务</li>
      <li>确保防火墙没有阻止GitHub的请求</li>
    </ul>
  </div>

  <script>
    // 获取元素
    const webhookUrlElement = document.getElementById('webhook-url');
    const testGetButton = document.getElementById('test-get');
    const testPingButton = document.getElementById('test-ping');
    const testPushButton = document.getElementById('test-push');
    const responseElement = document.getElementById('response');
    
    // 获取隧道状态并更新Webhook URL
    async function updateWebhookUrl() {
      try {
        const response = await fetch('/tunnel/status');
        const data = await response.json();
        
        if (data.isConnected && data.tunnelUrl) {
          webhookUrlElement.textContent = `${data.tunnelUrl}/webhook/github`;
        } else {
          webhookUrlElement.textContent = '内网穿透未连接，无法获取公网URL';
        }
      } catch (error) {
        console.error('获取隧道状态失败:', error);
        webhookUrlElement.textContent = '获取Webhook URL失败';
      }
    }
    
    // 发送测试请求
    async function sendTestRequest(method, eventType, payload) {
      responseElement.textContent = '发送请求中...';
      
      try {
        const headers = {
          'Content-Type': 'application/json'
        };
        
        if (eventType) {
          headers['X-GitHub-Event'] = eventType;
          headers['X-GitHub-Delivery'] = `test-${Date.now()}`;
        }
        
        const options = {
          method,
          headers
        };
        
        if (payload) {
          options.body = JSON.stringify(payload);
        }
        
        const response = await fetch('/webhook/github', options);
        const text = await response.text();
        
        try {
          // 尝试解析为JSON
          const json = JSON.parse(text);
          responseElement.textContent = JSON.stringify(json, null, 2);
        } catch (e) {
          // 如果不是JSON，直接显示文本
          responseElement.textContent = text;
        }
      } catch (error) {
        console.error('测试请求失败:', error);
        responseElement.textContent = `错误: ${error.message}`;
      }
    }
    
    // 事件监听
    testGetButton.addEventListener('click', () => {
      sendTestRequest('GET');
    });
    
    testPingButton.addEventListener('click', () => {
      sendTestRequest('POST', 'ping', {
        zen: 'Keep it simple.',
        hook_id: 12345,
        hook: {
          type: 'Repository',
          id: 12345,
          name: 'web',
          active: true,
          events: ['push'],
          config: {
            content_type: 'json',
            url: webhookUrlElement.textContent
          }
        },
        repository: {
          id: 67890,
          name: 'test-repo',
          full_name: 'user/test-repo',
          owner: {
            login: 'user',
            id: 54321
          }
        },
        sender: {
          login: 'user',
          id: 54321
        }
      });
    });
    
    testPushButton.addEventListener('click', () => {
      sendTestRequest('POST', 'push', {
        ref: 'refs/heads/main',
        before: '0000000000000000000000000000000000000000',
        after: '1234567890abcdef1234567890abcdef12345678',
        repository: {
          id: 67890,
          name: 'test-repo',
          full_name: 'user/test-repo',
          owner: {
            name: 'user',
            login: 'user',
            id: 54321
          }
        },
        pusher: {
          name: 'user',
          email: 'user@example.com'
        },
        sender: {
          login: 'user',
          id: 54321
        },
        commits: [
          {
            id: '1234567890abcdef1234567890abcdef12345678',
            message: '测试提交',
            timestamp: new Date().toISOString(),
            author: {
              name: 'Test User',
              email: 'test@example.com'
            },
            added: ['test.txt'],
            modified: [],
            removed: []
          }
        ]
      });
    });
    
    // 初始化
    updateWebhookUrl();
    
    // 定期刷新Webhook URL
    setInterval(updateWebhookUrl, 30000);
  </script>
</body>
</html>